## 세마포어: 멀티 프로그래밍 환경에서 공유 자원에 대한 접근을 제한

```
현재 공유자원에 접근할 수 있는 쓰레드, 프로세스의 수를 나타내는 값(S)을 두어 상호배제를 달성하는 기법
```
최대 (S)개까지 공유자원에 접근이 가능하다는 의미이다. 

**정수형** 변수 S와 연산 P, V

P: 임계 구역에 들어가기 전 수행 (프로세스 진입 여부를 자원의 개수(S)를 통해 결정) , Wait 동작이라고도 함

V: 임계 구역에서 나올 떄 수행 ( 자원 반납을 알림, 대기중인 프로세스를 깨움), Signal 동작이라고도 함

```c
P(S);

// --- 임계 구역 ---

V(S);
```

```c
procedure P(S)   --> 최초 S값은 1임
    while S=0 do wait  --> S가 0면 1이 될때까지 기다려야 함
    S := S-1   --> S를 0로 만들어 다른 프로세스가 들어 오지 못하도록 함
end P

--- 임계 구역 ---

procedure V(S) --> 현재상태는 S가 0임
    S := S+1   --> S를 1로 원위치시켜 해제하는 과정
end V
```

### S가 1일때 예시! (이진 세마포어. 뮤텍스처럼 1개만 동기화 가능일 때 예시)

최초 S값은 1이고, 현재 해당 구역을 수행할 프로세스 A,B가 있다.

1. 먼저 도착한 A🐱가 P(S)를 실행하여 S를 0으로 만들고 임계구역에 들어간다.
2. 그 뒤 도착한 B🐶가 P(S)를 실행하지만 S가 0이므로 대기상태이다.
3. A🐱가 임계구역 수행을 마치고 V(S)를 실행하면 S는 1이 된다.
4. B🐶는 이제 P(S)에서 무한루프를 빠져나올 수 있고, 임계구역으로 들어가 수행한다.

---

## 뮤텍스 : 임계 구역을 가진 스레드들의 실행시간이 서로 겹치지 않고 각각 단독으로 실행되게 하는 기술

상호배제(**Mut**ual **Ex**clusion)

**lock/unlock**을 사용한다.

- lock: 현재 임계 구역에 들어갈 권한을 얻어옴( 다른 프로세스/스레드가 임계 구역 수행중이면 종료시까지 대기)
- unlock: 현재 임계 구역을 모두 사용했음을 알림(대기중인 프로세스/스레드가 진입 가능)

### 3가지 알고리즘

### 1. 데커 알고리즘
    
    프로세스가 임계 영역에 진입하고 싶으면, 플래그를 설정하고 차례를 기다린다. 임계영역에 있는 프로세스가 종료될때까지 while문에서 순환한다. 프로세스간의 순서를 나타내는 turn 변수를 사용한다.
    
    ```jsx
    while(true) {
        flag[i] = true; // 프로세스 i가 임계 구역 진입 시도
        while(flag[j]) { // 프로세스 j가 현재 임계 구역에 있는지 확인
            if(turn == j) { // j가 임계 구역 사용 중이면
                flag[i] = false; // 프로세스 i 진입 취소
                while(turn == j); // turn이 j에서 변경될 때까지 대기
                flag[i] = true; // j turn이 끝나면 다시 진입 시도
            }
        }
    }
    
    // ------- 임계 구역 ---------
    
    turn = j; // 임계 구역 사용 끝나면 turn을 넘김
    flag[i] = false; // flag 값을 false로 바꿔 임계 구역 사용 완료를 알림
    ```
    
### 2. 피터슨 알고리즘

데커와 유사하지만, 상대방 프로세스/스레드에게 진입 기회를 양보하는 것에 차이가 있다.

피터슨 알고리즘은 임계 영역 조건 3가지를 이론상 완벽하게 해결할 수 있도록 한다.

```jsx
while(true) {
    flag[i] = true; // 프로세스 i가 임계 구역 진입 시도
    turn = j; // 다른 프로세스에게 진입 기회 양보
    while(flag[j] && turn == j) { // 다른 프로세스가 진입 시도하면 대기
    }
}

// ------- 임계 구역 ---------

flag[i] = false; // flag 값을 false로 바꿔 임계 구역 사용 완료를 알림

```

 하지만 실제로는 상호배제가 정상적으로 이루어지지 않는다. 

### 왜?

현대식 프로세스가 자행하는 최적화 때문.

프로세스는 최적화를 위해 서로 의존성이 없는 연산에 대해 실행순서를 임의로 변경한다.

### 3. 베이커리 알고리즘
    
    여러 프로세스/스레드에 대한 처리가 가능한 알고리즘. 가장 작은 수의 번호표를 가지고 있는 프로세스가 임계 구역에 진입한다.
    
    ```jsx
    while(true) {
        
        isReady[i] = true; // 번호표 받을 준비
        number[i] = max(number[0~n-1]) + 1; // 현재 실행 중인 프로세스 중에 가장 큰 번호 배정 
        isReady[i] = false; // 번호표 수령 완료
        
        for(j = 0; j < n; j++) { // 모든 프로세스 번호표 비교
            while(isReady[j]); // 비교 프로세스가 번호표 받을 때까지 대기
            while(number[j] && number[j] < number[i] && j < i);
            
            // 프로세스 j가 번호표 가지고 있어야 함
            // 프로세스 j의 번호표 < 프로세스 i의 번호표
        }
    
        // ------- 임계 구역 ---------
    
        number[i] = 0; // 임계 구역 사용 종료
    }
    ```
    

### 차이점

|  | 세마포어 | 뮤텍스 |
| --- | --- | --- |
| 동기화 대상 | 동기화 대상이 여러개 | 동기화 대상이 하나 |
| 자원 소유와 책임 | 공유자원 소유 불가 | 공유 자원의 소유 가능. 소유주가 이에 대한 책임을 짐 |

뮤텍스는 상태가 lock, unlock 두 개이므로 lock을 가질 수 있다.

소유하고 있는 쓰레드 만이 뮤택스를 해제할 수 있기 때문에 해당 쓰레드가 공유 자원에 대한 책임을 갖게된다.

하지만 세마포어의 경우 다양한 상태가 존재하여 세마포어를 소유하지 않는 스레드가 세마포어를 해제시킬 수 있다.

뮤텍스를 때때로 이진 세마포어라고도 부르지만, 진정한 뮤텍스는 뮤텍스를 잠근 작업만이 잠금을 해제해야한다는 점에서 보다 구체적인 사용 사례와 정의를 갖고 있다.
